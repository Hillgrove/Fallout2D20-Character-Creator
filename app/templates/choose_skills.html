{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mt-5">Choose Your Skills</h1>
    <form method="POST" action="{{ url_for('choose_skills', character_id=character_id) }}">
        {{ form.hidden_tag() }}

        <div class="form-group">
            <div class="row mb-3">
                <div class="col-md-3"><strong>Skill</strong></div>
                <div class="col-md-3"><strong>Rank</strong></div>
                <div class="col-md-3"><strong>Tagged</strong></div>
                <div class="col-md-3"><strong>Total</strong></div>
            </div>
            {% for skill in skills %}
                
                <!-- Row -->
                <div class="row mb-3 skill-row" data-skill-id="{{ skill.id }}">
                    
                    <!-- Skill name -->
                    <div class="col-md-3">{{ skill.name }}</div>

                    <!-- Rank value -->
                    <div class="col-md-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <button type="button" class="btn btn-secondary" onclick="changeStatValue('{{ form['skill_' ~ skill.id].id }}', -1)">-</button>
                            </div>
                            <input type="number" name="{{ form['skill_' ~ skill.id].name }}" id="{{ form['skill_' ~ skill.id].id }}" class="form-control text-center rank-input" value="{{ form['skill_' ~ skill.id].data or 0 }}" min="{{ form['skill_' ~ skill.id].validators[-1].min }}" max="{{ form['skill_' ~ skill.id].validators[-1].max }}" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-secondary" onclick="changeStatValue('{{ form['skill_' ~ skill.id].id }}', 1)">+</button>
                            </div>
                        </div>
                    </div>

                    
                    <!-- Tagged -->
                    <div class="col-md-3">
                        {{ form['tagged_' ~ skill.id](class="form-check-input tagged-checkbox") }}
                    </div>

                    <!-- Total Sum -->
                    <div class="col-md-3">
                        <span id="total_{{ skill.id }}">{{ form['skill_' ~ skill.id].data or 0 }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const formGroup = document.querySelector('.form-group');

    function updateTotal(skillRow) {
        const skillId = skillRow.getAttribute('data-skill-id');
        const rankInput = skillRow.querySelector('.rank-input');
        const taggedCheckbox = skillRow.querySelector('.tagged-checkbox');
        const totalSpan = document.getElementById('total_' + skillId);
        
        let total = parseInt(rankInput.value) || 0;
        if (taggedCheckbox.checked) {
            total += 2;
        }

        totalSpan.textContent = total;
    }

    formGroup.addEventListener('input', function (event) {
        if (event.target.classList.contains('rank-input') || event.target.classList.contains('tagged-checkbox')) {
            const skillRow = event.target.closest('.skill-row');
            updateTotal(skillRow);
        }
    });
});

function changeStatValue(inputId, delta) {
    const input = document.getElementById(inputId);
    let currentValue = parseInt(input.value) || 0;
    let minValue = parseInt(input.min) || 0;
    let maxValue = parseInt(input.max) || 100; // Use a default max value if not set

    // Update the value based on delta and ensure it stays within bounds
    currentValue += delta;
    if (currentValue < minValue) currentValue = minValue;
    if (currentValue > maxValue) currentValue = maxValue;

    input.value = currentValue;

    // Trigger input event to update the total
    const skillRow = input.closest('.skill-row');
    if (skillRow) {
        updateTotal(skillRow);
    }
}
</script>
{% endblock %}
