{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mt-5">Choose Your Skills</h1>
    <form method="POST" action="{{ url_for('choose_skills', character_id=character_id) }}">
        {{ form.hidden_tag() }}

        <div class="form-group">
            <label>Total Points Available: <span id="total_points">{{ total_points }}</span></label>
        </div>

        <div class="form-group">
            <div class="row mb-3">
                <div class="col-md-3"><strong>Skill</strong></div>
                <div class="col-md-3"><strong>Rank</strong></div>
                <div class="col-md-3"><strong>Tagged</strong></div>
                <div class="col-md-3"><strong>Total</strong></div>
            </div>
            {% for skill in skills %}
                <!-- Row -->
                <div class="row mb-3 skill-row" data-skill-id="{{ skill.id }}">
                    <!-- Skill name -->
                    <div class="col-md-3">{{ skill.name }}</div>

                    <!-- Rank value -->
                    <div class="col-md-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <button type="button" class="btn btn-secondary decrement-btn" data-input-id="{{ form['skill_' ~ skill.id].id }}">-</button>
                            </div>
                            <input type="number" name="{{ form['skill_' ~ skill.id].name }}" id="{{ form['skill_' ~ skill.id].id }}" class="form-control text-center rank-input" value="{{ form['skill_' ~ skill.id].data or 0 }}" min="0" max="3" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-secondary increment-btn" data-input-id="{{ form['skill_' ~ skill.id].id }}">+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tagged -->
                    <div class="col-md-3">
                        {{ form['tagged_' ~ skill.id](class="form-check-input tagged-checkbox", disabled=(skill.name in free_tag_skills)) }}
                    </div>

                    <!-- Total Sum -->
                    <div class="col-md-3">
                        <span id="total_{{ skill.id }}">{{ form['skill_' ~ skill.id].data or 0 }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Counter for selectable tags -->
        <div id="selectable_tags_counter" class="text-muted mt-2">
            0 / <span id="selectable_tags_limit">{{ max_tags }}</span> tags selected
        </div>
        
        <button type="submit" class="btn btn-primary" id="submit-button" disabled>Submit</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const totalPointsElement = document.getElementById('total_points');
    const selectableTagsCounter = document.getElementById('selectable_tags_counter');
    const selectableTagsLimit = parseInt(document.getElementById('selectable_tags_limit').textContent);
    const submitButton = document.getElementById('submit-button');
    const taggedCheckboxes = document.querySelectorAll('.tagged-checkbox');
    let totalPoints = parseInt(totalPointsElement.textContent);

    function calculateSpentPoints() {
        let spentPoints = 0;
        const skillFields = document.querySelectorAll('.rank-input');
        skillFields.forEach(function(skillField) {
            const value = parseInt(skillField.value) || 0;
            spentPoints += value;
        });
        return spentPoints;
    }

    window.changeStatValue = function(inputId, delta) {
        const input = document.getElementById(inputId);
        let currentValue = parseInt(input.value) || 0;

        console.log(`Initial value of ${inputId}: ${currentValue}, delta: ${delta}`);

        // Calculate the new value
        let newValue = currentValue + delta;
        if (newValue < 0) newValue = 0;
        if (newValue > 3) newValue = 3;

        console.log(`Updating value of ${inputId} from ${currentValue} to ${newValue} with delta ${delta}`);

        // Calculate the spent points if this change is applied
        let spentPoints = calculateSpentPoints() - currentValue + newValue;

        console.log(`Spent points before applying new value: ${spentPoints}`);

        // Check if the new value exceeds the total points
        if (spentPoints > totalPoints) {
            console.log(`Cannot update ${inputId} to ${newValue}. Not enough points.`);
            return;
        }

        input.value = newValue;

        const skillRow = input.closest('.skill-row');
        updateTotal(skillRow);
        updateTotalPoints();
    };

    function updateTotal(skillRow) {
        const skillId = skillRow.getAttribute('data-skill-id');
        const rankInput = skillRow.querySelector('.rank-input');
        const taggedCheckbox = skillRow.querySelector('.tagged-checkbox');
        const totalSpan = document.getElementById('total_' + skillId);
        
        let total = parseInt(rankInput.value) || 0;
        let adjustment = 0;

        if (taggedCheckbox && taggedCheckbox.checked) {
            total += 2;
            if (total > 3) {
                adjustment = total - 3;
                rankInput.value = parseInt(rankInput.value) - adjustment;
                total = 3;
                updateTotalPoints();
            }
        }

        console.log(`Updating total for skill ${skillId} to ${total}`);

        totalSpan.textContent = total;
    }

    function updateTagsCounter() {
        const selectedTags = document.querySelectorAll('.tagged-checkbox:checked').length;
        selectableTagsCounter.innerHTML = `${selectedTags} / ${selectableTagsLimit} tags selected`;

        taggedCheckboxes.forEach(checkbox => {
            if (selectedTags >= selectableTagsLimit && !checkbox.checked) {
                checkbox.disabled = true;
            } else {
                checkbox.disabled = false;
            }
        });

        const remainingPoints = parseInt(totalPointsElement.textContent);
        submitButton.disabled = selectedTags > selectableTagsLimit || remainingPoints < 0;

        console.log('Tags:', selectedTags, 'Limit:', selectableTagsLimit);
        console.log('Remaining Points:', remainingPoints);
    }

    function updateTotalPoints() {
        let spentPoints = calculateSpentPoints();
        const remainingPoints = totalPoints - spentPoints;
        totalPointsElement.textContent = remainingPoints;

        console.log(`Total Points: ${totalPoints}`);
        console.log(`Spent Points: ${spentPoints}`);
        console.log(`Remaining Points: ${remainingPoints}`);

        const skillFields = document.querySelectorAll('.rank-input');
        skillFields.forEach(function(skillField) {
            const incrementButton = skillField.parentElement.querySelector('.increment-btn');
            const decrementButton = skillField.parentElement.querySelector('.decrement-btn');
            const value = parseInt(skillField.value) || 0;
            const totalSpan = skillField.closest('.skill-row').querySelector('span[id^="total_"]');
            const total = parseInt(totalSpan.textContent) || 0;

            console.log(`Skill ${skillField.id} has value ${value} and total ${total}`);

            // Dim the increase button if the total sum is 3 or if no remaining points
            if (incrementButton) {
                incrementButton.disabled = total >= 3 || remainingPoints <= 0;
                if (total >= 3 || remainingPoints <= 0) {
                    incrementButton.classList.add('disabled');
                } else {
                    incrementButton.classList.remove('disabled');
                }
            }

            // Dim the decrease button if the value is 0
            if (decrementButton) {
                decrementButton.disabled = value <= 0;
                if (value <= 0) {
                    decrementButton.classList.add('disabled');
                } else {
                    decrementButton.classList.remove('disabled');
                }
            }
        });

        updateTagsCounter();
    }

    document.querySelectorAll('.increment-btn').forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            changeStatValue(this.getAttribute('data-input-id'), 1);
        });
    });

    document.querySelectorAll('.decrement-btn').forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            changeStatValue(this.getAttribute('data-input-id'), -1);
        });
    });

    taggedCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const skillRow = checkbox.closest('.skill-row');
            updateTotal(skillRow);
            updateTagsCounter();
            updateTotalPoints();  // Recalculate total points to undim buttons if needed
        });
    });

    // Initialize the counter on page load
    updateTotalPoints();
});
</script>
{% endblock %}
