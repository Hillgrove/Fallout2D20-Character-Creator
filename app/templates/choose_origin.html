{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Create Character</h1>
    <form id="create-character-form" method="POST" action="{{ url_for('choose_origin') }}">
        {{ form.hidden_tag() }}

        <!-- Name section -->
        <div class="form-group row">
            <label class="col-sm-2 col-form-label">{{ form.name.label.text }}</label>
            <div class="col-sm-3">
                {{ form.name(class="form-control") }}
                {% for error in form.name.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- Origin section -->
        <div class="form-group row">
            <label class="col-sm-2 col-form-label">{{ form.origin_id.label.text }}</label>
            <div class="col-sm-3">
                {{ form.origin_id(class="form-control", id="origin_id") }}
                {% for error in form.origin_id.errors %}
                    <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- Stat section -->
        <div class="form-group row" id="special_stats_section" style="display: none;">
            <label class="col-sm-4 col-form-label">S.P.E.C.I.A.L Stats</label>
            <div class="col-sm-9">
                <div id="special_stats" class="row">
                    <!-- Stats will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Background description section -->
        <div class="form-group row" id="background_description_section" style="display: none;">
            <label for="origin_description" class="col-sm-3 col-form-label">Background Description</label>
            <div class="col-sm-9">
                <p id="origin_description" class="form-control-static"></p>
            </div>
        </div>

        <!-- Non-Selectable Trait section -->
        <div class="form-group row" id="non_selectable_traits_section" style="display: none;">
            <label class="col-sm-3 col-form-label">Non-Selectable Traits</label>
            <div class="col-sm-9">
                <ul id="non_selectable_traits">
                    <!-- Non-selectable traits will be dynamically inserted here -->
                </ul>
            </div>
        </div>

        <!-- Selectable Trait section -->
        <div class="form-group row" id="selectable_traits_section" style="display: none;">
            <label class="col-sm-3 col-form-label">{{ form.selectable_traits.label.text }}</label>
            <div class="col-sm-9">
                <div id="selectable_traits">
                    {% for subfield in form.selectable_traits %}
                        <div class="form-check">
                            {{ subfield(class="form-check-input") }}
                            {{ subfield.label(class="form-check-label") }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Next button -->
        <div class="form-group row">
            <div class="col-sm-9">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </div>

    </form>
</div>

<script>
// JavaScript to dynamically update the background description, selectable traits, and S.P.E.C.I.A.L stats
document.getElementById('origin_id').addEventListener('change', function() {
    // Get the selected background ID
    var originId = this.value;

    // Sections to show/hide
    var specialStatsSection = document.getElementById('special_stats_section');
    var backgroundDescriptionSection = document.getElementById('background_description_section');
    var selectableTraitsSection = document.getElementById('selectable_traits_section');
    var nonSelectableTraitsSection = document.getElementById('non_selectable_traits_section');
    var form = document.getElementById('create-character-form');

    if (originId == -1) {
        document.getElementById('origin_description').innerText = '';
        document.getElementById('selectable_traits').innerHTML = '';
        document.getElementById('special_stats').innerHTML = '';
        document.getElementById('non_selectable_traits').innerHTML = '';

        specialStatsSection.style.display = 'none';
        backgroundDescriptionSection.style.display = 'none';
        selectableTraitsSection.style.display = 'none';
        nonSelectableTraitsSection.style.display = 'none';

        return;
    }

    // Disable the "Select an Origin" option
    this.options[0].disabled = true;

    // Make an AJAX request to fetch the description, selectable traits, and S.P.E.C.I.A.L stats
    fetch('{{ url_for("get_origin_description") }}?origin_id=' + originId)
        .then(response => response.json())
        .then(data => {
            // Show the sections
            specialStatsSection.style.display = 'block';
            backgroundDescriptionSection.style.display = 'block';
            selectableTraitsSection.style.display = data.selectable_traits.length > 0 ? 'block' : 'none';
            nonSelectableTraitsSection.style.display = data.non_selectable_traits.length > 0 ? 'block' : 'none';

            // Update the description paragraph
            document.getElementById('origin_description').innerText = data.description;

            // Update the selectable traits
            var traitsDiv = document.getElementById('selectable_traits');
            traitsDiv.innerHTML = ''; // Clear previous options

            data.selectable_traits.forEach(function(trait) {
                var div = document.createElement('div');
                div.className = 'form-check';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.name = 'selectable_traits';
                checkbox.value = trait.id;
                checkbox.id = 'selectable_trait_' + trait.id;

                var label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = 'selectable_trait_' + trait.id;
                label.innerText = trait.name;

                div.appendChild(checkbox);
                div.appendChild(label);

                traitsDiv.appendChild(div);
            });

            // Update the non-selectable traits
            var nonSelectableTraitsDiv = document.getElementById('non_selectable_traits');
            nonSelectableTraitsDiv.innerHTML = ''; // Clear previous traits

            data.non_selectable_traits.forEach(function(trait) {
                var li = document.createElement('li');
                li.innerHTML = '<strong>' + trait.name + ':</strong> ' + trait.description;
                nonSelectableTraitsDiv.appendChild(li);
            });

            // Update the S.P.E.C.I.A.L stats
            var statsDiv = document.getElementById('special_stats');
            statsDiv.innerHTML = ''; // Clear previous stats

            data.special_stats.forEach(function(stat) {
                var div = document.createElement('div');
                div.className = 'col-sm-12 d-flex align-items-center'; // Bootstrap class for full-width column and centering

                var label = document.createElement('label');
                label.className = 'col-sm-2 mb-0'; // Removed col-form-label and added mb-0 for no margin-bottom
                label.style.padding = '0'; // Remove padding
                label.innerText = stat.name + ': ';

                var span = document.createElement('span');
                span.className = 'col-sm-2 form-control-static';
                span.innerText = ' ' + stat.min + ' - ' + stat.max;

                div.appendChild(label);
                div.appendChild(span);

                statsDiv.appendChild(div);
            });

            // Update the selectable traits limit in the form data
            form.setAttribute('data-trait-limit', data.selectable_traits_limit);
        });
});
</script>
{% endblock %}
