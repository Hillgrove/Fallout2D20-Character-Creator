{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Choose S.P.E.C.I.A.L. Stats for {{ character.name }}</h1>
    <form method="POST" action="{{ url_for('choose_stats', character_id=character.id) }}">
        {{ form.hidden_tag() }}

        <div class="form-group">
            <label>Total Points Available: <span id="total_points"></span></label>
        </div>

        {% for field in form %}
            {% if field.name != 'csrf_token' and field.type == 'IntegerField' %}
            <div class="form-group row">

                <!-- Label -->
                <label class="col-sm-2 col-form-label">{{ field.label.text }}</label>
                
                <!-- Input field w. buttons -->
                <div class="col-sm-3">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <button type="button" class="btn btn-secondary" onclick="changeStatValue('{{ field.name }}', -1)">-</button>
                        </div>
                        <input type="number" name="{{ field.name }}" id="{{ field.name }}" class="form-control text-center" value="{{ field.data or 5 }}" min="{{ field.validators[-1].min }}" max="{{ field.validators[-1].max }}" readonly>
                        <div class="input-group-append">
                            <button type="button" class="btn btn-secondary" onclick="changeStatValue('{{ field.name }}', 1)">+</button>
                        </div>
                    </div>
                </div>

            </div>
            {% endif %}
        {% endfor %}

        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>

    <div class="mt-4">
        <h2>Derived Stats</h2>
        <p>Carry Weight: <span id="carry_weight"></span> lbs.</p>
        <p>Initiative: <span id="initiative"></span></p>
    </div>
</div>

<script>
function changeStatValue(statId, delta) {
    var input = document.getElementById(statId);
    var min = parseInt(input.min);
    var max = parseInt(input.max);
    var value = parseInt(input.value) + delta;

    if (value >= min && value <= max) {
        input.value = value;
        updateTotalPoints();
    }
}

function updateTotalPoints() {
    var totalPoints = {{ character.starting_stat_points }};
    var spentPoints = 0;
    var statFields = Array.from(document.querySelectorAll('input[type="number"]')).map(input => input.id);

    statFields.forEach(function(statField) {
        var input = document.getElementById(statField);
        if (input) {
            spentPoints += parseInt(input.value);
        }
    });

    var remainingPoints = totalPoints - spentPoints;
    document.getElementById('total_points').innerText = remainingPoints;

    statFields.forEach(function(statField) {
        var input = document.getElementById(statField);
        if (input) {
            var value = parseInt(input.value);

            document.querySelector(`button[onclick="changeStatValue('${statField}', 1)"]`).disabled = remainingPoints <= 0 || value >= parseInt(input.max);
            document.querySelector(`button[onclick="changeStatValue('${statField}', -1)"]`).disabled = value <= parseInt(input.min);
        }
    });

    updateDerivedStats();
}

function updateDerivedStats() {
    var strength = parseInt(document.getElementById('strength').value);
    var perception = parseInt(document.getElementById('perception').value);
    var agility = parseInt(document.getElementById('agility').value);
    
    var carryWeight = {{ carry_weight_base }} + (strength * 10);
    document.getElementById('carry_weight').innerText = carryWeight;

    var initiative = perception + agility;
    document.getElementById('initiative').innerText = initiative;
}

updateTotalPoints();
</script>
{% endblock %}
