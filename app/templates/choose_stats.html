{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Choose S.P.E.C.I.A.L. Stats for {{ character.name }}</h1>
    <form method="POST" action="{{ url_for('choose_stats', character_id=character.id) }}">
        {{ form.hidden_tag() }}

        <div class="form-group">
            <label>Total Points Available: <span id="total_points"></span></label>
        </div>

        {% for field in form %}
            {% if field.name != 'csrf_token' and field.type == 'IntegerField' %}
            <div class="form-group row">
                <!-- Label -->
                <label class="col-sm-2 col-form-label">{{ field.label.text }}</label>

                <!-- Input field w. buttons -->
                <div class="col-sm-3">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <button type="button" class="btn btn-secondary" onclick="changeStatValue('{{ field.name }}', -1)">-</button>
                        </div>
                        <input type="number" name="{{ field.name }}" id="{{ field.name }}" class="form-control text-center" value="{{ field.data or 4 }}" min="4" max="{{ field.validators[-1].max }}" readonly>
                        <div class="input-group-append">
                            <button type="button" class="btn btn-secondary" onclick="changeStatValue('{{ field.name }}', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <!-- Next button -->
        <div class="form-group">
            {{ form.submit(class="btn btn-primary", id="submit-button") }}
        </div>
    </form>

    <div class="mt-4">
        <h2>Derived Stats</h2>
        <p>Carry Weight: <span id="carry_weight"></span> lbs.</p>
        <p>Initiative: <span id="initiative"></span></p>
        <p>Defense: <span id="defense"></span></p>
        <p>Hitpoints: <span id="hitpoints"></span></p>
        <p>Melee Damage: <span id="melee_damage"></span></p>
        <p>Skill Points: <span id="skill_points"></span></p>
    </div>
</div>

<script>
    function changeStatValue(statId, delta) {
        var input = document.getElementById(statId);
        var min = 4; // Set the minimum value to 4
        var max = parseInt(input.max);
        var value = parseInt(input.value) + delta;

        if (value >= min && value <= max) {
            input.value = value;
            updateTotalPoints();
            updateDerivedStats();  // Ensure derived stats are updated on every change
        }
    }

    function updateTotalPoints() {
        var totalPoints = {{ character.starting_stat_points }} + {{ extra_special_points }};
        var spentPoints = 0;
        var statFields = Array.from(document.querySelectorAll('input[type="number"]')).map(input => input.id);

        statFields.forEach(function(statField) {
            var input = document.getElementById(statField);
            if (input) {
                spentPoints += parseInt(input.value);
            }
        });

        var remainingPoints = totalPoints - spentPoints;
        document.getElementById('total_points').innerText = remainingPoints;

        statFields.forEach(function(statField) {
            var input = document.getElementById(statField);
            if (input) {
                var value = parseInt(input.value);

                document.querySelector(`button[onclick="changeStatValue('${statField}', 1)"]`).disabled = remainingPoints <= 0 || value >= parseInt(input.max);
                document.querySelector(`button[onclick="changeStatValue('${statField}', -1)"]`).disabled = value <= 4; // Ensure the minimum value is 4
            }
        });

        // Enable or disable the submit button based on remaining points
        var submitButton = document.getElementById('submit-button');
        submitButton.disabled = remainingPoints !== 0;
    }

    function updateDerivedStats() {
        // Make sure we have the latest values from the inputs
        var strength = parseInt(document.getElementById('strength').value);
        var perception = parseInt(document.getElementById('perception').value);
        var endurance = parseInt(document.getElementById('endurance').value);
        var agility = parseInt(document.getElementById('agility').value);
        var luck = parseInt(document.getElementById('luck').value);
        var intelligence = parseInt(document.getElementById('intelligence').value);

        // Derived stats calculations remain unchanged
        var carryWeight = {{ carry_weight_base }} + (strength * 10);
        if ({{ carry_weight_trait|tojson }}) {
            carryWeight = {{ carry_weight_base }};
        }
        document.getElementById('carry_weight').innerText = carryWeight;

        var initiative = perception + agility;
        document.getElementById('initiative').innerText = initiative;

        var defense = agility >= 9 ? 2 : 1;
        document.getElementById('defense').innerText = defense;

        var hitpoints = endurance + luck;
        document.getElementById('hitpoints').innerText = hitpoints;

        var meleeDamage = 0;
        if (strength >= 11) {
            meleeDamage = 3;
        } else if (strength >= 9) {
            meleeDamage = 2;
        } else if (strength >= 7) {
            meleeDamage = 1;
        }
        document.getElementById('melee_damage').innerText = meleeDamage;

        var skillPoints = 9 + intelligence;
        document.getElementById('skill_points').innerText = skillPoints;
    }

    // Initialize the page correctly on load
    document.getElementById('submit-button').disabled = true;
    updateTotalPoints();
    updateDerivedStats();
</script>

{% endblock %}
